/* Copyright (C) 2016 RDA Technologies Limited and/or its affiliates("RDA").
* All rights reserved.
*
* This software is supplied "AS IS" without any warranties.
* RDA assumes no responsibility or liability for the use of the software,
* conveys no license or title under any patent, copyright, or mask work
* right to the product. RDA reserves the right to make changes in the
* software without notification.  RDA also make no representation or
* warranty that such application will be suitable for the specified use
* without further testing or modification.
*/
















#include "cs_types.h"

#include "hal_error.h"
#include "hal_voc.h"

#include "calib_m.h"

#include "vppp_audiojpegenc_map.h"
#include "mcip_debug.h"
#include "vpp_audiojpegenc.h"
#include "vppp_audiojpegenc_asm.h"

#define PIXEL_SCALE_BIT 14
#define Mask_SCALE_BIT 0x3fff

//=============================================================================
// vpp_AudioJpegEncOpen function
//-----------------------------------------------------------------------------
HAL_ERR_T vpp_AudioJpegEncOpen(HAL_VOC_IRQ_HANDLER_T vocIrqHandler)
{
    HAL_VOC_CFG_T cfg;
    vpp_AudioJpeg_ENC_IN_T * pEncIn;
    vpp_AudioJpeg_ENC_OUT_T *pEncStatus;
    INT32 * *pDMA;

    diag_printf("[vpp_AudioJpeg_ENC]Opening VPP AUDIO_ENC\n");


    cfg.vocCode              = G_VppCommonEncCode;
    cfg.vocCodeSize        = G_VppAudJpegMainCodeSize;
    cfg.pcVal                   = VPP_AUDIOJPEGENC_MAIN_ENTRY;
    cfg.pcValCriticalSecMin  = VPP_AUDIOJPEGENC_CRITICAL_SECTION_MIN;
    cfg.pcValCriticalSecMax  = VPP_AUDIOJPEGENC_CRITICAL_SECTION_MAX;
    cfg.needOpenDoneIrq      = FALSE;
    cfg.irqMask.voc          = (vocIrqHandler) ? 1 : 0;
    cfg.irqMask.dmaVoc       = 0;
    cfg.vocIrqHandler        = vocIrqHandler;

    cfg.eventMask.wakeupIfc0 = 0;
    cfg.eventMask.wakeupIfc1 = 0;
    cfg.eventMask.wakeupDmae = 0;
    cfg.eventMask.wakeupDmai = 0;
    cfg.eventMask.wakeupSof0 = 0;
    cfg.eventMask.wakeupSof1 = 0;
    cfg.enableFlashAccess =false;
    // load the VPP AUDIO_ENC  code and configure the VoC resource
    switch (hal_VocOpen(&cfg))
    {
        // error opening the resource
        case HAL_ERR_RESOURCE_BUSY:
            diag_printf("[vpp_AudioJpeg_ENC]##WARNING##Error opening VoC resource\n");
            return HAL_ERR_RESOURCE_BUSY;

        // first open, load the constant tables
        case HAL_ERR_RESOURCE_RESET:
            diag_printf("[vpp_AudioJpeg_ENC]First open.\n");
            break;

        default:
            diag_printf("[vpp_AudioJpeg_ENC]No first open.\n");
            break;
    }

    diag_printf("[vpp_AudioJpeg_ENC]Initializing the DMA addr.\n");
#ifdef MP3_ENC_SUPPORT

    //mp3
    pDMA = hal_VocGetPointer(VPP_MP3_Enc_Code_ExternalAddr_addr);
    *pDMA = hal_VocGetDmaiPointer((INT32*)G_VppMp3EncCode,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA = pDMA + 1;
    *pDMA = hal_VocGetDmaiPointer((INT32*)G_VppMp3EncConstX,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA = pDMA + 1;
    *pDMA=hal_VocGetDmaiPointer((INT32*)G_VppMp3EncConstY,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA=pDMA + 1;
    *pDMA=hal_VocGetDmaiPointer((INT32*)G_VppMp3EncConst_rqmy,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA=pDMA + 1;
    *pDMA=hal_VocGetDmaiPointer((INT32*)G_VppMp3EncConst_Zig,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
#endif
    //amr
    pDMA = hal_VocGetPointer(VPP_AMR_Enc_Code_ExternalAddr_addr);

    *pDMA = hal_VocGetDmaiPointer((INT32*)G_VppAmrJpegEncCode,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA = pDMA + 1;
    *pDMA = hal_VocGetDmaiPointer((INT32*)G_VppAmrJpegEncConstX,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pDMA = pDMA+1;
    *pDMA = hal_VocGetDmaiPointer((INT32*)G_VppAmrJpegEncConstY,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);

    //YUV420 RGB656 ROTATE
    pDMA = hal_VocGetPointer(RGBYUV_ROTATE_Code_ExternalAddr_addr);
    *pDMA = hal_VocGetDmaiPointer((INT32*)G_vocYUVRomateCode,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);

    pEncIn = hal_VocGetPointer(vpp_AudioJpeg_ENC_IN_STRUCT);
    pEncIn->reset = 1;
    pEncStatus = (vpp_AudioJpeg_ENC_OUT_T *)hal_VocGetPointer(vpp_AudioJpeg_ENC_OUT_STRUCT);
    pEncStatus->ErrorStatus = 0;
    pEncStatus->mode = -1;//not 0~9;

    // move to STALL location (VoC irq generated)
    return  hal_VocWakeup(HAL_VOC_START);
}


//=============================================================================
// vpp_AudioJpegEncClose function
//-----------------------------------------------------------------------------
void vpp_AudioJpegEncClose(void)
{
    hal_VocClose();
    diag_printf("[vpp_AudioJpeg_ENC]Closing VPP\n");

}
//=============================================================================
// vpp_AudioJpegEncStatus function
//-----------------------------------------------------------------------------
void vpp_AudioJpegEncStatus(vpp_AudioJpeg_ENC_OUT_T * pEncStatus)
{
    // copy status structure from VoC RAM to the destination.
    *pEncStatus = *((vpp_AudioJpeg_ENC_OUT_T *)hal_VocGetPointer(vpp_AudioJpeg_ENC_OUT_STRUCT));
}

//=============================================================================
// vpp_AudioJpegEncScheduleOneFrame function
//-----------------------------------------------------------------------------
HAL_ERR_T vpp_AudioJpegEncScheduleOneFrame(vpp_AudioJpeg_ENC_IN_T *pEncIn)
{
    vpp_AudioJpeg_ENC_IN_T *pEncInVoC = (vpp_AudioJpeg_ENC_IN_T *)hal_VocGetPointer(vpp_AudioJpeg_ENC_IN_STRUCT);

    *pEncInVoC = *pEncIn;

    pEncInVoC->inStreamBufAddr = hal_VocGetDmaiPointer(pEncIn->inStreamBufAddr,  HAL_VOC_DMA_READ,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pEncInVoC->outStreamBufAddr = hal_VocGetDmaiPointer(pEncIn->outStreamBufAddr,HAL_VOC_DMA_WRITE,HAL_VOC_DMA_BURST,HAL_VOC_DMA_B2S_NO);
    pEncIn->reset=0;
    // diag_printf("[vpp_AudioJpeg_ENC]Coencmode:%d\n",pEncInVoC->mode);

    if (pEncInVoC->mode==4)
    {
        int xScale =(((pEncInVoC->SampleRate&0xffff)-1)<<(PIXEL_SCALE_BIT))/pEncInVoC->imag_width;
        int yScale =(((pEncInVoC->SampleRate>>16)-1)<<(PIXEL_SCALE_BIT))/pEncInVoC->imag_height;

        int* ptr32=(int *)hal_VocGetPointer(GLOBAL_xScale);

        *ptr32++=xScale;
        *ptr32++=yScale;
    }

    // schedule next frame on sof0 event
    return hal_VocWakeup(HAL_VOC_WAKEUP_EVENT_0);
}

PUBLIC UINT32 vpp_AudioJpegEncMicAlgGainDb2Val(INT32 db)
{
    CONST UINT32 micAlgVal[] =
    {
        0x40, 0x5a, 0x80, 0xb5,
        0x100, 0x16a, 0x200, 0x2d4,
        0x400, 0x5a8, 0x800, 0xb50,
        0x1000, 0x16a0, 0x2000, 0x2d40,
    };
    if (db == CALIB_AUDIO_GAIN_VALUE_MUTE)
        return 0;
    if (db < 0)
        db = 0;
    else if (db > 45)
        db = 45;
    return micAlgVal[db/3];
}

//=============================================================================
// vpp_AudioJpegEncSetInAlgGain function
//-----------------------------------------------------------------------------
///
//=============================================================================
PUBLIC VOID vpp_AudioJpegEncSetInAlgGain(INT32 alg)
{
    UINT32 algGain = vpp_AudioJpegEncMicAlgGainDb2Val(alg);
    * ( UINT16 *) hal_VocGetPointer(GLOBAL_MIC_DIGITAL_GAIN_ADDR)=algGain;
}

#if 0
void  VPP_WRITE_JPEGHeadr(short quality_select,
                          short width,
                          short height,
                          uint8 *JPEG_buffer)
{

    const static int8 head1[20]=
    {
        0xff,0xd8,0xff,0xe0,0x0,0x10,0x4a,0x46,0x49,0x46,0x0,0x1,0x1,
        0x0,0x0,0x1,0x0,0x1,0x0,0x0
    };
#if 0
    static int8 head_q_l[136]=
    {
        0xff,0xdb,0x0,0x84,0x0,0x10,0xb,0xc,0xe,0xc,0xa,0x10,0xe,0xd,0xe,
        0x12,0x11,0x10,0x13,0x18,0x28,0x1a,0x18,0x16,0x16,0x18,0x31,0x23,
        0x25,0x1d,0x28,0x3a,0x33,0x3d,0x3c,0x39,0x33,0x38,0x37,0x40,0x48,
        0x5c,0x4e,0x40,0x44,0x57,0x45,0x37,0x38,0x50,0x6d,0x51,0x57,0x5f,
        0x62,0x67,0x68,0x67,0x3e,0x4d,0x71,0x79,0x70,0x64,0x78,0x5c,0x65,
        0x67,0x63,0x1,0x11,0x12,0x12,0x18,0x15,0x18,0x2f,0x1a,0x1a,0x2f,
        0x63,0x42,0x38,0x42,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0xff,0xc0
    };
#else
    const static int8 head_q_l[136]=
    {
        0xff,0xdb,0x0,0x84,

        0x0,
        0x6  ,0x4  ,0x5  ,0x8  ,0x6  ,0x4  ,0x4  ,0x9  ,
        0x6  ,0xb  ,0xc  ,0xa  ,0x6  ,0x6  ,0x5  ,0x4  ,
        0x5  ,0x8  ,0xa  ,0xc  ,0xf  ,0x13  ,0xe  ,0xc  ,
        0xc  ,0xb  ,0x6  ,0x6  ,0x5  ,0x9  ,0xc  ,0x10  ,
        0x10  ,0xc  ,0x1c  ,0x1f  ,0x1f  ,0x1b  ,0x13  ,0xc  ,
        0xc  ,0xa  ,0xb  ,0xa  ,0xc  ,0xe  ,0x13  ,0x1b  ,
        0x1f  ,0x1f  ,0x1b  ,0x14  ,0xf  ,0xc  ,0x10  ,0x14  ,
        0x1c  ,0x1f  ,0x1f  ,0x1f  ,0x13  ,0x1f  ,0x1f  ,0x1f  ,

        0x1,
        0x7  ,0x7  ,0x10  ,0x1f  ,0x18  ,0x7  ,0xd  ,0x1a  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x15  ,0xc  ,0xd  ,
        0x11  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x15  ,0x18  ,0x10  ,0x1a  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,

        0xff,0xc0
    };
#endif
    const static int8 head_q_h[136]=
    {
        0xff,0xdb,0x0,0x84,0x0,0x2,0x1,0x1,0x1,0x1,0x1,0x2,0x1,0x1,0x1,
        0x2,0x2,0x2,0x2,0x2,0x4,0x3,0x2,0x2,0x2,0x2,0x5,0x4,0x4,0x3,
        0x4,0x6,0x5,0x6,0x6,0x6,0x5,0x6,0x6,0x6,0x7,0x9,0x8,0x6,0x7,
        0x9,0x7,0x6,0x6,0x8,0xb,0x8,0x9,0xa,0xa,0xa,0xa,0xa,0x6,0x8,
        0xb,0xc,0xb,0xa,0xc,0x9,0xa,0xa,0xa,0x1,0x2,0x2,0x2,0x2,0x2,
        0x2,0x5,0x3,0x3,0x5,0xa,0x7,0x6,0x7,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xff,0xc0
    };


    static int8 head_size_128_411[10]=
    {
        0x0,0x11,0x8,0x0,0x60,0x0,0x80,0x3,0x1,0x22,
    };

    const static int8 head_4[441]=
    {
        0x0,0x2,0x11,0x1,0x3,0x11,0x1,
        0xff,0xc4,0x1,0xa2,0x0,0x0,0x1,0x5,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,
        0x0,0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xb,0x10,0x0,0x2,0x1,0x3,0x3,0x2,0x4,
        0x3,0x5,0x5,0x4,0x4,0x0,0x0,0x1,0x7d,0x1,0x2,0x3,0x0,0x4,0x11,0x5,0x12,0x21,0x31,0x41,
        0x6,0x13,0x51,0x61,0x7,0x22,0x71,0x14,0x32,0x81,0x91,0xa1,0x8,0x23,0x42,0xb1,0xc1,0x15,
        0x52,0xd1,0xf0,0x24,0x33,0x62,0x72,0x82,0x9,0xa,0x16,0x17,0x18,0x19,0x1a,0x25,0x26,0x27,
        0x28,0x29,0x2a,0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x43,0x44,0x45,0x46,0x47,0x48,0x49,
        0x4a,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5a,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6a,
        0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7a,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x92,
        0x93,0x94,0x95,0x96,0x97,0x98,0x99,0x9a,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,
        0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,0xb8,0xb9,0xba,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,
        0xca,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,0xd8,0xd9,0xda,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
        0xe8,0xe9,0xea,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0x1,0x0,0x3,0x1,0x1,
        0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,
        0x9,0xa,0xb,0x11,0x0,0x2,0x1,0x2,0x4,0x4,0x3,0x4,0x7,0x5,0x4,0x4,0x0,0x1,0x2,0x77,0x0,
        0x1,0x2,0x3,0x11,0x4,0x5,0x21,0x31,0x6,0x12,0x41,0x51,0x7,0x61,0x71,0x13,0x22,0x32,0x81,
        0x8,0x14,0x42,0x91,0xa1,0xb1,0xc1,0x9,0x23,0x33,0x52,0xf0,0x15,0x62,0x72,0xd1,0xa,0x16,
        0x24,0x34,0xe1,0x25,0xf1,0x17,0x18,0x19,0x1a,0x26,0x27,0x28,0x29,0x2a,0x35,0x36,0x37,
        0x38,0x39,0x3a,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4a,0x53,0x54,0x55,0x56,0x57,0x58,
        0x59,0x5a,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6a,0x73,0x74,0x75,0x76,0x77,0x78,0x79,
        0x7a,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x92,0x93,0x94,0x95,0x96,0x97,0x98,
        0x99,0x9a,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
        0xb8,0xb9,0xba,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xd2,0xd3,0xd4,0xd5,0xd6,
        0xd7,0xd8,0xd9,0xda,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,0xe8,0xe9,0xea,0xf2,0xf3,0xf4,0xf5,
        0xf6,0xf7,0xf8,0xf9,0xfa,0xff,0xda,0x0,0xc,0x3,0x1,0x0,0x2,0x11,0x3,0x11,0x0,0x3f,0x0
    };
    ///////////////////////////////////////////////////////////////////////////
    int i;
    uint8*  ptemp = JPEG_buffer+1;

    //fwrite(head1,20,1,pout);
    for(i=0; i<20; i++)
    {
        *ptemp++ = head1[i];
    }

    if (quality_select==0)
    {
        // fwrite(head_q_l,136,1,pout);
        for(i=0; i<136; i++)
            *ptemp++ = head_q_l[i];
    }
    else
    {
        //fwrite(head_q_h,136,1,pout);
        for(i=0; i<136; i++)
            *ptemp++ = head_q_h[i];
    }



    head_size_128_411[3]=height>>8;
    head_size_128_411[4]=height&0xff;
    head_size_128_411[5]=width>>8;
    head_size_128_411[6]=width&0xff;


    if (width<=350)
    {
        head_size_128_411[9] = 0x22;//411
    }
    else if (width<=700)
    {
        head_size_128_411[9] = 0x21;//422
    }
    else if(width==1280 && height==1024)
    {
        head_size_128_411[9] = 0x21;//422
    }
    else
    {
        //retun;
        diag_printf("too big size to encode\n");
    }

    ////////////////////////////

    for(i=0; i<10; i++)
        *ptemp++ = head_size_128_411[i];


    for(i=0; i<441; i++)
    {
        *ptemp++ = head_4[i];
    }

    //printf("write jpeg enc head ok\n");


}
#endif

void  VPP_WRITE_JPEGHeadr(short quality_select,
                          short width,
                          short height,
                          uint8 *JPEG_buffer)
{

    const static int8 head1[20]=
    {
        0xff,0xd8,0xff,0xe0,0x0,0x10,0x4a,0x46,0x49,0x46,0x0,0x1,0x1,
        0x0,0x0,0x1,0x0,0x1,0x0,0x0
    };
#if 0
    static int8 head_q_l[136]=
    {
        0xff,0xdb,0x0,0x84,0x0,0x10,0xb,0xc,0xe,0xc,0xa,0x10,0xe,0xd,0xe,
        0x12,0x11,0x10,0x13,0x18,0x28,0x1a,0x18,0x16,0x16,0x18,0x31,0x23,
        0x25,0x1d,0x28,0x3a,0x33,0x3d,0x3c,0x39,0x33,0x38,0x37,0x40,0x48,
        0x5c,0x4e,0x40,0x44,0x57,0x45,0x37,0x38,0x50,0x6d,0x51,0x57,0x5f,
        0x62,0x67,0x68,0x67,0x3e,0x4d,0x71,0x79,0x70,0x64,0x78,0x5c,0x65,
        0x67,0x63,0x1,0x11,0x12,0x12,0x18,0x15,0x18,0x2f,0x1a,0x1a,0x2f,
        0x63,0x42,0x38,0x42,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,0x63,
        0x63,0x63,0xff,0xc0
    };
#else
    const static int8 head_q_l[136]=
    {
        0xff,0xdb,0x0,0x84,

        0x0,
        0x6  ,0x4  ,0x5  ,0x8  ,0x6  ,0x4  ,0x4  ,0x9  ,
        0x6  ,0xb  ,0xc  ,0xa  ,0x6  ,0x6  ,0x5  ,0x4  ,
        0x5  ,0x8  ,0xa  ,0xc  ,0xf  ,0x13  ,0xe  ,0xc  ,
        0xc  ,0xb  ,0x6  ,0x6  ,0x5  ,0x9  ,0xc  ,0x10  ,
        0x10  ,0xc  ,0x1c  ,0x1f  ,0x1f  ,0x1b  ,0x13  ,0xc  ,
        0xc  ,0xa  ,0xb  ,0xa  ,0xc  ,0xe  ,0x13  ,0x1b  ,
        0x1f  ,0x1f  ,0x1b  ,0x14  ,0xf  ,0xc  ,0x10  ,0x14  ,
        0x1c  ,0x1f  ,0x1f  ,0x1f  ,0x13  ,0x1f  ,0x1f  ,0x1f  ,

        0x1,
        0x7  ,0x7  ,0x10  ,0x1f  ,0x18  ,0x7  ,0xd  ,0x1a  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x15  ,0xc  ,0xd  ,
        0x11  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x15  ,0x18  ,0x10  ,0x1a  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,
        0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,0x1f  ,

        0xff,0xc0
    };
#endif
    const static int8 head_q_h[136]=
    {
        0xff,0xdb,0x0,0x84,0x0,0x2,0x1,0x1,0x1,0x1,0x1,0x2,0x1,0x1,0x1,
        0x2,0x2,0x2,0x2,0x2,0x4,0x3,0x2,0x2,0x2,0x2,0x5,0x4,0x4,0x3,
        0x4,0x6,0x5,0x6,0x6,0x6,0x5,0x6,0x6,0x6,0x7,0x9,0x8,0x6,0x7,
        0x9,0x7,0x6,0x6,0x8,0xb,0x8,0x9,0xa,0xa,0xa,0xa,0xa,0x6,0x8,
        0xb,0xc,0xb,0xa,0xc,0x9,0xa,0xa,0xa,0x1,0x2,0x2,0x2,0x2,0x2,
        0x2,0x5,0x3,0x3,0x5,0xa,0x7,0x6,0x7,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,
        0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xa,0xff,0xc0
    };


    static int8 head_size_128_411[10]=
    {
        0x0,0x11,0x8,0x0,0x60,0x0,0x80,0x3,0x1,0x22,
    };

    const static int8 head_4[441]=
    {
        0x0,0x2,0x11,0x1,0x3,0x11,0x1,
        0xff,0xc4,0x1,0xa2,0x0,0x0,0x1,0x5,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,
        0x0,0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,0xa,0xb,0x10,0x0,0x2,0x1,0x3,0x3,0x2,0x4,
        0x3,0x5,0x5,0x4,0x4,0x0,0x0,0x1,0x7d,0x1,0x2,0x3,0x0,0x4,0x11,0x5,0x12,0x21,0x31,0x41,
        0x6,0x13,0x51,0x61,0x7,0x22,0x71,0x14,0x32,0x81,0x91,0xa1,0x8,0x23,0x42,0xb1,0xc1,0x15,
        0x52,0xd1,0xf0,0x24,0x33,0x62,0x72,0x82,0x9,0xa,0x16,0x17,0x18,0x19,0x1a,0x25,0x26,0x27,
        0x28,0x29,0x2a,0x34,0x35,0x36,0x37,0x38,0x39,0x3a,0x43,0x44,0x45,0x46,0x47,0x48,0x49,
        0x4a,0x53,0x54,0x55,0x56,0x57,0x58,0x59,0x5a,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6a,
        0x73,0x74,0x75,0x76,0x77,0x78,0x79,0x7a,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x92,
        0x93,0x94,0x95,0x96,0x97,0x98,0x99,0x9a,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,
        0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,0xb8,0xb9,0xba,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,
        0xca,0xd2,0xd3,0xd4,0xd5,0xd6,0xd7,0xd8,0xd9,0xda,0xe1,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,
        0xe8,0xe9,0xea,0xf1,0xf2,0xf3,0xf4,0xf5,0xf6,0xf7,0xf8,0xf9,0xfa,0x1,0x0,0x3,0x1,0x1,
        0x1,0x1,0x1,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,
        0x9,0xa,0xb,0x11,0x0,0x2,0x1,0x2,0x4,0x4,0x3,0x4,0x7,0x5,0x4,0x4,0x0,0x1,0x2,0x77,0x0,
        0x1,0x2,0x3,0x11,0x4,0x5,0x21,0x31,0x6,0x12,0x41,0x51,0x7,0x61,0x71,0x13,0x22,0x32,0x81,
        0x8,0x14,0x42,0x91,0xa1,0xb1,0xc1,0x9,0x23,0x33,0x52,0xf0,0x15,0x62,0x72,0xd1,0xa,0x16,
        0x24,0x34,0xe1,0x25,0xf1,0x17,0x18,0x19,0x1a,0x26,0x27,0x28,0x29,0x2a,0x35,0x36,0x37,
        0x38,0x39,0x3a,0x43,0x44,0x45,0x46,0x47,0x48,0x49,0x4a,0x53,0x54,0x55,0x56,0x57,0x58,
        0x59,0x5a,0x63,0x64,0x65,0x66,0x67,0x68,0x69,0x6a,0x73,0x74,0x75,0x76,0x77,0x78,0x79,
        0x7a,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x92,0x93,0x94,0x95,0x96,0x97,0x98,
        0x99,0x9a,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xb2,0xb3,0xb4,0xb5,0xb6,0xb7,
        0xb8,0xb9,0xba,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xd2,0xd3,0xd4,0xd5,0xd6,
        0xd7,0xd8,0xd9,0xda,0xe2,0xe3,0xe4,0xe5,0xe6,0xe7,0xe8,0xe9,0xea,0xf2,0xf3,0xf4,0xf5,
        0xf6,0xf7,0xf8,0xf9,0xfa,0xff,0xda,0x0,0xc,0x3,0x1,0x0,0x2,0x11,0x3,0x11,0x0,0x3f,0x0
    };

    ///////////////////////////////////////////////////////////////////////////
    int i;
    uint8*  ptemp = JPEG_buffer+1;
    uint8*  ptemp1;

    ptemp1 = (uint8*)head1;

    for(i=5; i>0; i--)
    {
        *ptemp = *ptemp1;
        *(ptemp+1) = *(ptemp1+1);
        *(ptemp+2) = *(ptemp1+2);
        *(ptemp+3) = *(ptemp1+3);
        ptemp +=4; ptemp1+=4;
    }

    if (quality_select==0)
    {
        ptemp1 = (uint8*)head_q_l;
    }
    else
    {
        ptemp1 = (uint8*)head_q_h;
    }

    for(i=34; i>0; i--)
    {
        *ptemp = *ptemp1;
        *(ptemp+1) = *(ptemp1+1);
        *(ptemp+2) = *(ptemp1+2);
        *(ptemp+3) = *(ptemp1+3);
        ptemp +=4; ptemp1+=4;
    }

    head_size_128_411[3]=height>>8;
    head_size_128_411[4]=height&0xff;
    head_size_128_411[5]=width>>8;
    head_size_128_411[6]=width&0xff;

    if (width<=350)
    {
        head_size_128_411[9] = 0x21;//4//422
    }
    else if (width<=700)
    {
        head_size_128_411[9] = 0x21;//422
    }
    else if(width==1280 && height==1024)
    {
        head_size_128_411[9] = 0x21;//422
    }
    else
    {
        head_size_128_411[9] = 0x21;//422
    }

    ////////////////////////////
    ptemp1 = (uint8*)head_size_128_411;
    for(i=5; i>0; i--)
    {
        *ptemp = *ptemp1;
        *(ptemp+1) = *(ptemp1+1);
        ptemp +=2; ptemp1+=2;
    }

    ptemp1 = (uint8*)head_4;

    for(i=110; i>0; i--)
    {
        *ptemp = *ptemp1;
        *(ptemp+1) = *(ptemp1+1);
        *(ptemp+2) = *(ptemp1+2);
        *(ptemp+3) = *(ptemp1+3);
        ptemp +=4; ptemp1+=4;
    }

    *ptemp = *ptemp1;
}




